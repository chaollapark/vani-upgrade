server {
    listen 80;
    server_name localhost;

    root /var/www/html;
    index index.php;

    client_max_body_size 100M;

    # Short URL: /wiki/Page_Title -> /w/index.php?title=Page_Title
    location /wiki/ {
        rewrite ^/wiki/(.*)$ /w/index.php?title=$1 last;
    }

    # Redirect /wiki to /wiki/
    location = /wiki {
        rewrite ^ /wiki/ redirect;
    }

    # MediaWiki PHP files
    location ~ ^/w/(.+\.php)$ {
        fastcgi_pass mediawiki-vanipedia:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/html/w/$1;
        include fastcgi_params;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param DOCUMENT_URI $document_uri;
        fastcgi_param DOCUMENT_ROOT /var/www/html;
        fastcgi_param SERVER_NAME $server_name;
        fastcgi_param SERVER_PORT $server_port;
        fastcgi_param HTTPS off;
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Static files for MediaWiki
    location /w/ {
        try_files $uri $uri/ =404;
    }

    # Images
    location /w/images/ {
        alias /var/www/html/w/images/;
    }

    # Deny access to sensitive files
    location ~ /w/(\.ht|\.git|composer\.|vendor/) {
        deny all;
    }

    # Deny access to LocalSettings.php directly
    location = /w/LocalSettings.php {
        deny all;
    }
}
